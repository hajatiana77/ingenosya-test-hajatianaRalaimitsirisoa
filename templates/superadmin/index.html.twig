{% extends 'superadmin/base_superadmin.html.twig' %}

{% block content %}
<style>	
	.update_user,.delete_user{
		cursor: pointer;
	}
</style>
<div class="vd_head-section clearfix" style="background-color: #fff">
    <div class="vd_panel-header">
        <ul class="breadcrumb">
            <li><a href="">{{'Administrator space'|trans}}</a> </li>
            <li class="active">{{'Users'|trans}}</li>
        </ul>
    </div>
</div>
{% for message in app.flashes('notice') %}
    <div class="flash-notice">
    {{ message }}
    </div>
{% endfor %}
<div class="vd_title-section clearfix">
    <div class="vd_panel-header">
        <div class="toolbar_container">
            <div class="col-md-12">
                <div class="row toolbar">					
                    <div class="tools_left" style="float: left;">
                    	<div class="tools">
                    		<div class="elements">
                                <div class="btn btn-danger btn-perso" id="add_user">creer</div>
                                <div class="btn btn-default btn-sm" data-content="impression" data-toggle="popover" id="btn_impression"><i class="glyphicon glyphicon-print"></i></div>
                                <div class="btn btn-default btn-sm" data-content="exporter" data-toggle="popover" id="btn_exporter"><i class="glyphicon glyphicon-export"></i></div>
        						<div class="btn btn-default btn-sm" title="" data-original-title="" data-toggle="popover" data-content="Rechercher" id="btn_search"><i class="glyphicon glyphicon-search"></i></div>
                                <div class="btn btn-default btn-sm" data-content="annuler" data-toggle="popover" id="btn_cancel"><i class="glyphicon glyphicon-remove"></i></div>
                            </div>
                    	</div>
                    </div>
                    <div class="tools_right" style="float: right;">
                        <span style="margin: 5px;">
                		  <div class="tools" style="float: left; margin: 5px;" id="custom_pagination_info"></div>
                        </span>
                		<div class="tools prev_and_next" style="float: left;">
                			<div class="btn-group" style="float: left;">
                				<div class="btn btn-default table_previous">
                					<i class="glyphicon glyphicon-arrow-left"></i>
                				</div>
                				<div class="btn btn-default table_next">
                					<i class="glyphicon glyphicon-arrow-right"></i>
                				</div>
                			</div>
                		</div>
                		<div class="tools list_and_form" style="float: right;">
                			<div class="btn-group" style="float: right;">
                				<div data-toggle="popover" data-content="Vue&nbsp;liste" class="btn btn-default list_view">
                					<i class="glyphicon glyphicon-th"></i>
                				</div>
                				<div data-toggle="popover" data-content="Vue&nbsp;formulaire" class="btn btn-default form_view">
                					<i class="glyphicon glyphicon-calendar"></i>
                				</div>
                			</div>
                		</div>
                    </div>
                </div>
				<!-- Outils de recherche -->
                <div class="row">
                    <div class="col-md-7">
                    	<div class="row">
                    		<div class="form-group-perso">
                                <label class="control-label col-sm-4 left">Nom & prénom</label>
                                <div class="col-sm-8">
                                	<input type="text" class="form-control form-control-perso typehead tt-query" id="nom_prenom" name="nom_prenom" autocomplete='off'>
                                </div>
                    		</div>
                    	</div>
                        <div class="row">
                    		<div class="form-group-perso">
                      		    <label class="control-label col-sm-4 left">Email</label>
                        		<div class="col-sm-8">
                        			<input type="text" class="form-control form-control-perso typehead tt-query" id="pseudo" name="pseudo" autocomplete='off'>
                        		</div>
                    		</div>
                    	</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="vd_content-section clearfix" style="background-color: #fff;overflow-y:scroll;">
    <div class="row list_container">
        <div class="col-md-12">
            <div class="panel-body table-responsive">
                {# data-url="/superadmin/getlistemembre"#}
              <table 
                    data-url="{{ path('superadminsuperadmin_getlistemembre') }}"
                    data-toggle="table" 
                    data-click-to-select="true" id="list_users" 
                    data-pagination="true" 
                    data-page-number="1"
                    data-search="false" 
                    data-show-refresh="false" 
                    data-show-toggle="false" 
                    data-show-columns="false" class="table table-stripped" 
                    data-side-pagination="server" 
                    data-sort-ordre = "ASC"                    
                    data-page-size="10">
                <thead>
                    <tr>
                        <th data-field="username" data-sortable="true">Nom & Prénom</th>					
                        <th data-field="email" data-sortable="true">Email</th>
                        <th data-field="roles" data-formatter="role_formatter" data-sortable="true">Rôles</th>
                        <th data-field="enable" data-formatter="actif_formatter" data-sortable="true">Actif</th>                        				
                        <th data-field="actions" data-formatter="actions_formatter" data-events="actions_user">Actions</th>
                    </tr>
                </thead>
              </table>
            </div>
        </div>
    </div>  
</div>

<script type="text/javascript">            
	function init_table(){
        $('#list_users').bootstrapTable({             
    		queryParams : function (params) {
    	    	var q = {
    	                "limit": params.pageSize,
    	                "offset": params.pageSize * (params.pageNumber - 1),
    	                "search": params.searchText,
                        "name": params.sortName,
                        "order": params.sortOrder
    	            };
                $('.pagination').hide();
                $('.pagination-info').hide();
                $('#limit').val(params.pageSize);
                return q;
            },
            onLoadSuccess : function (data) {
       	        $('.pagination').hide();
    	    	$('.pagination-info').hide();
    	    	$('#custom_pagination_info').html($('.pagination-info').html());
                var chn_offset=$('.pagination-info').html();
                var tab_offset=chn_offset.split('-');
                if(tab_offset[0]>0){
        		  $('#offset').val(tab_offset[0]);
                }
    	    	total_rows = data.total;                                                                      
       	    },
            onClickRow : function(row){                  
                document.location.href ="/superadmin/editUser/"+row.id;
            }
             /*, onLoadError: function (status) {
                //return false;
                alert(status);
             }*/ 	   
    	});
    }
    
    init_table(); 
    
    $('.table_previous').on('click', function(){	   
        $('.pagination > .page-pre').trigger('click');
    });

	$('.table_next').on('click', function(){
	   $('.pagination > .page-next').trigger('click');                
    });   
    
    function actif_formatter(value, row){
        if(value){
            return 'Actif';
        } else {
            return 'Inactif';
        }        
    }
    
    function actions_formatter(){
        return '<i class="glyphicon glyphicon-edit update_user"></i> <i class="glyphicon glyphicon-trash delete_user"></i>';
    }
    
    window.actions_user = {
		'click .delete_user' : function (e, value, row, index){
			e.stopPropagation(); // idem as before
			Swal.fire({
				title: 'Voulez vous vraiment supprimer?',
				text: "L'action est irreversible",
				type: 'warning',
				showCancelButton: true,
				cancelButtonText : "Annuler",
				confirmButtonColor: '#3085d6',
				cancelButtonColor: '#d33',
				confirmButtonText: 'Supprimer'
				})
			.then((result) => {
				if (result.value) {
					$.ajax({
						url: "{{ path('superadminsuperadmin_deleteuser') }}",
						data: {id : row.id},
						type: 'POST',
						success: function(data){
							if(data.status=='success'){
								$('#list_users').bootstrapTable('refresh', {silent: true});
								swal.fire('Suppression réussi.','Utilisateur supprimé.','success');
							}else{
                                swal.fire('Suppression échoué.','Utilisateur déjà utilisé.Non supprimable.','error');
							}
						},
						error: function(e){
							ErrorMessage.show('Une erreur s\'est produite');
						}
					});
				}
				else if (result.dismiss === Swal.DismissReason.cancel) {}
			});
		},
        'click .update_user' : function(e, value, row, index){
            e.stopPropagation();
            document.location.href = "/superadmin/editUser/"+row.id;
        }
	}
</script>

{% endblock %}
